name: Linux Builds for Net::AMQP::RabbitMQ
on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  COVERALLS_REPO_TOKEN: ${{ secrets.COVERALLS_REPO_TOKEN }}
  IS_OSX: false
  NARDEBUG: 1
  PERL_VERSION: ${{ matrix.perl-version }}
  MQSSL: ${{ env.MQSSL }}
  MQSSLCACERT: ${{ env.MQSSLCACERT }}
  MQSSLHOST: ${{ secrets.MQSSLHOST }}
  MQSSLUSERNAME: ${{ secrets.MQSSLUSERNAME }}
  MQSSLPASSWORD: ${{ secrets.MQSSLPASSWORD }}
  MQSSLPORT: ${{ secrets.MQSSLPORT }}
  MQSSLVHOST: ${{ secrets.MQSSLVHOST }}

jobs:
  perl-versions:
    runs-on: ubuntu-latest
    name: List Perl versions
    outputs:
      perl-versions: ${{ steps.action.outputs.perl-versions }}
    steps:
      - id: action
        uses: perl-actions/perl-versions@v1
        with:
          since-perl: v5.12
          with-devel: false

  linux-tests:
    needs:
      - perl-versions
    name: "Perl v${{ matrix.perl-version }}"
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        perl-version: ${{ fromJSON(needs.perl-versions.outputs.perl-versions) }}

    container:
      image: perldocker/perl-tester:${{ matrix.perl-version }}

    steps:

      - name: Check out code (w/submodules)
        uses: actions/checkout@main
        with:
          submodules: recursive

      - name: Install Perl dependencies
        uses: perl-actions/install-with-cpanm@v1
        with:
          cpanfile: "cpanfile"
          sudo: false
          args: "--with-test"

      - name: Run CI tests
        run: |
          echo "MQSSL:$MQSSL"
          sh ./ci/run-ci-tests.sh
